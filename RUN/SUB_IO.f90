SUBROUTINE RDSET(MODE,COUNTRY,REGION,STYR,ENYR,STDOY,ENDOY,POINTLON,POINTLAT,TRES,clmTRES,SEASON,WEST,EAST,NORTH,SOUTH,WERES,NSRES,IRRF_NAME,IRR,CRP_NAME,CRP_FILE,&
                 CNFILE,PLT_FILE,PLT_ROW,YLD_FILE,PRM_FILE,LAI_FILE,WSH_FILE,WSO_FILE,WAR_FILE,WST_FILE,WLF_FILE,WRT_FILE,WDL_FILE,CLIM_HEAD,CLIM_FOOT,GDHm_FILE,SMPL_FILE)

  IMPLICIT NONE
  
!!!  [OUTPUT]
  CHARACTER*5 MODE  ! Calculation scale
  CHARACTER*50 COUNTRY ! Calculating country
  CHARACTER*50 REGION ! Calculating region
  INTEGER STYR      ! Start year [Year]
  INTEGER ENYR      ! End year   [Year]
  INTEGER STDOY     ! Start DOY  [day]
  INTEGER ENDOY     ! End   DOY  [day]
  REAL*8 POINTLON   ! Longitude for point calculation
  REAL*8 POINTLAT   ! Latitude for point calculation

  INTEGER TRES      ! Time resolution [Second]
  CHARACTER*2 IRRF_NAME
  INTEGER clmTRES   ! Time resolution of climate forcing [Second]
  CHARACTER*5 SEASON ! season 1st 2nd 3rd

  REAL*8 WEST
  REAL*8 EAST
  REAL*8 NORTH
  REAL*8 SOUTH
  REAL*8 WERES
  REAL*8 NSRES
  
  INTEGER IRR
  INTEGER PLT_ROW

  CHARACTER*200 CRP_NAME    ! Crop selection (Rice, Wheat, Soybean)
  CHARACTER*200 CRP_FILE    ! File for vegetation parameter

  CHARACTER*200 CNFILE
  CHARACTER*200 PLT_FILE

  CHARACTER*200 YLD_FILE
  CHARACTER*200 PRM_FILE
  CHARACTER*200 LAI_FILE
  CHARACTER*200 WSH_FILE
  CHARACTER*200 WSO_FILE
  CHARACTER*200 WAR_FILE
  CHARACTER*200 WST_FILE
  CHARACTER*200 WLF_FILE
  CHARACTER*200 WRT_FILE
  CHARACTER*200 WDL_FILE

  CHARACTER*200 CLIM_HEAD
  CHARACTER*200 CLIM_FOOT

  CHARACTER*200 GDHm_FILE
  CHARACTER*200 SMPL_FILE

!!!  [VARIABLE]
  INTEGER IER

!!!  [BUFFER VARIABLE]
  CHARACTER*15 BUF15
  CHARACTER*200 BUF200

  CHARACTER*200 SETFILE
    
  CALL GETARG(1,SETFILE)
!  print *,SETFILE
  OPEN(10,file=SETFILE,status='old',iostat=IER)
!  print *,"koko"
  IF(IER .NE. 0)THEN
     WRITE(*,*),"SETTING.txt could not be opened"
     STOP
  ELSE
   READ(10,'(A200)')BUF200
   READ(10,'(A15,A5)')BUF15,MODE
   READ(10,'(A15,A50)')BUF15,COUNTRY
   READ(10,'(A15,A50)')BUF15,REGION
   READ(10,'(A15,I)')BUF15,STYR
   READ(10,'(A15,I)')BUF15,ENYR
   READ(10,'(A15,I)')BUF15,STDOY
   READ(10,'(A15,I)')BUF15,ENDOY
   READ(10,'(A15,F)')BUF15,POINTLON
   READ(10,'(A15,F)')BUF15,POINTLAT
   READ(10,'(A15,I)')BUF15,TRES
   READ(10,'(A15,I)')BUF15,clmTRES
   READ(10,'(A15,A)')BUF15,SEASON

   READ(10,'(A200)')BUF200
   READ(10,'(A15,A2)')BUF15,IRRF_NAME
   READ(10,'(A15,I)')BUF15,IRR
   
   READ(10,'(A200)')BUF200
   READ(10,'(A15,A200)')BUF15,CRP_NAME
   READ(10,'(A15,A200)')BUF15,CRP_FILE

   READ(10,'(A200)')BUF200
   READ(10,'(A15,A200)')BUF15,CNFILE
   
   READ(10,'(A200)')BUF200
   READ(10,'(A15,A200)')BUF15,PLT_FILE
   READ(10,'(A15,I)')BUF15,PLT_ROW

   READ(10,'(A200)')BUF200
   READ(10,'(A15,A200)')BUF15,YLD_FILE
   READ(10,'(A15,A200)')BUF15,PRM_FILE
   READ(10,'(A15,A200)')BUF15,LAI_FILE
   READ(10,'(A15,A200)')BUF15,WSH_FILE
   READ(10,'(A15,A200)')BUF15,WSO_FILE
   READ(10,'(A15,A200)')BUF15,WAR_FILE
   READ(10,'(A15,A200)')BUF15,WST_FILE
   READ(10,'(A15,A200)')BUF15,WLF_FILE
   READ(10,'(A15,A200)')BUF15,WRT_FILE
   READ(10,'(A15,A200)')BUF15,WDL_FILE

   READ(10,'(A200)')BUF200
   READ(10,'(A15,A200)')BUF15,CLIM_HEAD
   READ(10,'(A15,A5)')BUF15,CLIM_FOOT

   READ(10,'(A15,A200)')BUF15,GDHm_FILE
   READ(10,'(A15,A200)')BUF15,SMPL_FILE

   CLOSE(10)
  END IF

END SUBROUTINE RDSET

SUBROUTINE RDPRM(VEGFILE,RESPCP,EFFCON,ATHETA,BTHETA,MH2O,BH2O,KN,LTCH,ZKCA,ZKCB,ZKOA,ZKOB,GMMA,GMMB,RLFV,TLFV,RLFN,TLFN,hDVS,CFLF,CFST,CFRT,CFSO,VN,TB,TO,TH,LEFY0,LEFX1,LEFY1,LEFX2,LEFY2,LEFX3,LEFY3,PNCLX1,PNCLY1,PNCLX2,PNCLY2,PNCLX3,PNCLY3,DLFX1,DLFY1,DLFX2,DLFY2,DLFX3,DLFY3,LLFst,kLLF,RTX,RTY,RTX2,FSTR,SLWYA,SLWYB,SLWX,HGTAA,HGTAB,HGTBA,HGTBB,GZRT,MXRT,GMMSL,SLNX1,SLNX2,SLNX3,SLNYMX,SLNYMN,SLNK,TCmin,THcrit,HI,PLTDIF,HVT_TAVE)

   IMPLICIT NONE

!  [INPUT]
   CHARACTER*200 VEGFILE

!  [OUTPUT]
   REAL*8 RESPCP
   REAL*8 EFFCON    !
   REAL*8 ATHETA
   REAL*8 BTHETA
   REAL*8 MH2O
   REAL*8 BH2O
   REAL*8 KN
   REAL*8 LTCH
   REAL*8 ZKCA     ! Kc at 298K [Pa]
   REAL*8 ZKCB     ! Parameter for temperature dependence of Kc [-]
   REAL*8 ZKOA     ! Ko at 298K [Pa]
   REAL*8 ZKOB     ! Parameter for temperature dependence of Ko [-]
   REAL*8 GMMA     ! Parameter for temperature dependence of Gamma* [-]
   REAL*8 GMMB     ! Parameter for temperature dependence of Gamma* [-]

   REAL*8 RLFV
   REAL*8 TLFV
   REAL*8 RLFN
   REAL*8 TLFN
   REAL*8 hDVS  ! heading DVS
   REAL*8  CFLF         ! Fraction for leave
   REAL*8  CFST         ! Fraction for stem
   REAL*8  CFRT         ! Fraction for root
   REAL*8  CFSO         ! Fraction for storage orga
   REAL*8  RTX
   REAL*8  RTY
   REAL*8  RTX2

   INTEGER VN
   REAL*8 TB
   REAL*8 TO
   REAL*8 TH

   REAL*8  LEFY0
   REAL*8  LEFX1
   REAL*8  LEFY1
   REAL*8  LEFX2
   REAL*8  LEFY2
   REAL*8  LEFX3
   REAL*8  LEFY3
   REAL*8  PNCLX1
   REAL*8  PNCLY1
   REAL*8  PNCLX2
   REAL*8  PNCLY2
   REAL*8  PNCLX3
   REAL*8  PNCLY3
   REAL*8  DLFX1
   REAL*8  DLFY1
   REAL*8  DLFX2
   REAL*8  DLFY2
   REAL*8  DLFX3
   REAL*8  DLFY3
   REAL*8  LLFst
   REAL*8  kLLF
   REAL*8  FSTR
   REAL*8  SLWYA
   REAL*8  SLWYB
   REAL*8  SLWX
   REAL*8  HGTAA
   REAL*8  HGTAB
   REAL*8  HGTBA
   REAL*8  HGTBB
   REAL*8 GZRT   !Growth rate of root  [m/day]
   REAL*8 MXRT   !Maximum root length [m]
   REAL*8 GMMSL  ! soil water stress factor
   REAL*8 SLNX1
   REAL*8 SLNX2
   REAL*8 SLNX3
   REAL*8 SLNYMX
   REAL*8 SLNYMN
   REAL*8 SLNK
   REAL*8 TCmin
   REAL*8 THcrit
   REAL*8 HI
   REAL*8 PLTDIF
   REAL*8 HVT_TAVE

!  [VARIABLE]
   INTEGER IER

!  [BUFFER VARIABLE]
   CHARACTER*10 BUF10


   OPEN(11,file=VEGFILE,status='old',iostat=IER)
   IF(IER .NE. 0)THEN
      WRITE(*,*)VEGFILE, "vege could not be opened"
      STOP
   ELSE
      READ(11,'(A10,F)')BUF10,RESPCP
      READ(11,'(A10,F)')BUF10,EFFCON
      READ(11,'(A10,F)')BUF10,ATHETA
      READ(11,'(A10,F)')BUF10,BTHETA
      READ(11,'(A10,F)')BUF10,MH2O
      READ(11,'(A10,F)')BUF10,BH2O
      READ(11,'(A10,F)')BUF10,KN
      READ(11,'(A10,F)')BUF10,LTCH
      READ(11,'(A10,F)')BUF10,ZKCA
      READ(11,'(A10,F)')BUF10,ZKCB
      READ(11,'(A10,F)')BUF10,ZKOA
      READ(11,'(A10,F)')BUF10,ZKOB
      READ(11,'(A10,F)')BUF10,GMMA
      READ(11,'(A10,F)')BUF10,GMMB
      READ(11,'(A10,F)')BUF10,RLFV
      READ(11,'(A10,F)')BUF10,TLFV
      READ(11,'(A10,F)')BUF10,RLFN
      READ(11,'(A10,F)')BUF10,TLFN
      READ(11,'(A10,F)')BUF10,hDVS
      READ(11,'(A10,F)')BUF10,CFLF
      READ(11,'(A10,F)')BUF10,CFST
      READ(11,'(A10,F)')BUF10,CFRT
      READ(11,'(A10,F)')BUF10,CFSO
      READ(11,'(A10,I)')BUF10,VN
      READ(11,'(A10,F)')BUF10,TB
      READ(11,'(A10,F)')BUF10,TO
      READ(11,'(A10,F)')BUF10,TH
      READ(11,'(A10,F)')BUF10,LEFY0
      READ(11,'(A10,F)')BUF10,LEFX1
      READ(11,'(A10,F)')BUF10,LEFY1
      READ(11,'(A10,F)')BUF10,LEFX2
      READ(11,'(A10,F)')BUF10,LEFY2
      READ(11,'(A10,F)')BUF10,LEFX3
      READ(11,'(A10,F)')BUF10,LEFY3
      READ(11,'(A10,F)')BUF10,PNCLX1
      READ(11,'(A10,F)')BUF10,PNCLY1
      READ(11,'(A10,F)')BUF10,PNCLX2
      READ(11,'(A10,F)')BUF10,PNCLY2
      READ(11,'(A10,F)')BUF10,PNCLX3
      READ(11,'(A10,F)')BUF10,PNCLY3
      READ(11,'(A10,F)')BUF10,DLFX1
      READ(11,'(A10,F)')BUF10,DLFY1
      READ(11,'(A10,F)')BUF10,DLFX2
      READ(11,'(A10,F)')BUF10,DLFY2
      READ(11,'(A10,F)')BUF10,DLFX3
      READ(11,'(A10,F)')BUF10,DLFY3
      READ(11,'(A10,F)')BUF10,LLFst
      READ(11,'(A10,F)')BUF10,kLLF
      READ(11,'(A10,F)')BUF10,RTX
      READ(11,'(A10,F)')BUF10,RTY
      READ(11,'(A10,F)')BUF10,RTX2
      READ(11,'(A10,F)')BUF10,FSTR
      READ(11,'(A10,F)')BUF10,SLWYA
      READ(11,'(A10,F)')BUF10,SLWYB
      READ(11,'(A10,F)')BUF10,SLWX
      READ(11,'(A10,F)')BUF10,HGTAA
      READ(11,'(A10,F)')BUF10,HGTAB
      READ(11,'(A10,F)')BUF10,HGTBA
      READ(11,'(A10,F)')BUF10,HGTBB
      READ(11,'(A10,F)')BUF10,GZRT
      READ(11,'(A10,F)')BUF10,MXRT
      READ(11,'(A10,F)')BUF10,GMMSL
      READ(11,'(A10,F)')BUF10,SLNX1
      READ(11,'(A10,F)')BUF10,SLNX2
      READ(11,'(A10,F)')BUF10,SLNX3
      READ(11,'(A10,F)')BUF10,SLNYMX
      READ(11,'(A10,F)')BUF10,SLNYMN
      READ(11,'(A10,F)')BUF10,SLNK
      READ(11,'(A10,F)')BUF10,TCmin
      READ(11,'(A10,F)')BUF10,THcrit
      READ(11,'(A10,F)')BUF10,HI
      READ(11,'(A10,F)')BUF10,PLTDIF
      READ(11,'(A10,F)')BUF10,HVT_TAVE
      
      CLOSE(11)
   END IF

END SUBROUTINE RDPRM

SUBROUTINE RDCLIM(VAR,HEAD,COUNTRY,REGION,CLIMNAME,IRRF_NAME,SEASON,IYEAR,FOOT,NLON,NLAT,DAT_NTIME,FILE_CHECK)

   IMPLICIT NONE
   INTEGER NLON,NLAT,DAT_NTIME
   REAL*8 VAR(NLON,NLAT,DAT_NTIME)
   
   CHARACTER*200 HEAD
   CHARACTER*200 FOOT
   INTEGER*4 IYEAR
   !INTEGER*4 FYEAR
   CHARACTER*50 COUNTRY
   CHARACTER*50 REGION
   CHARACTER*5 CLIMNAME
   CHARACTER*2 IRRF_NAME
   CHARACTER*5 SEASON
   
   CHARACTER*4 YYYY
   INTEGER DATE
   INTEGER IER,iostatus
   CHARACTER*200 FILE
   INTEGER FILE_CHECK
   
   WRITE(YYYY,'(I4)')IYEAR
   
   !print *, YYYY
   FILE=TRIM(ADJUSTL(HEAD))//TRIM(ADJUSTL(CLIMNAME))//'/'//TRIM(ADJUSTL(COUNTRY))//'/'//TRIM(ADJUSTL(YYYY))//'_'//TRIM(ADJUSTL(IRRF_NAME))//TRIM(ADJUSTL(SEASON))//'_'//TRIM(ADJUSTL(CLIMNAME))//'_'//TRIM(ADJUSTL(REGION))//TRIM(ADJUSTL(FOOT))
   !/home/tnakagawa/MATCRO_JAPAN/MATCRO_R/Sap/SET/1990_tmp_Sap.txt
   
   OPEN(12,file=trim(FILE),status='old',iostat=IER)
   IF(IER .NE. 0)THEN
      !WRITE(*,*),"climate file could not be opened"
      !print *, FILE
      FILE_CHECK = FILE_CHECK + 1
      !STOP
   ELSE
      DO DATE=1,DAT_NTIME,1
         READ(12,*,iostat=iostatus) VAR(NLON,NLAT,DATE)
      END DO
   END IF
   CLOSE(12) 
   
END SUBROUTINE RDCLIM

SUBROUTINE RDCO2_NFERT(VAR1,VAR2,CNFILE,YEAR)

   IMPLICIT NONE
   REAL*8 VAR1,VAR2
   REAL*8 value
 
   CHARACTER*200 CNFILE
 
   INTEGER*4 IYEAR
   INTEGER*4 YEAR
   INTEGER DATE
   INTEGER IER,iostatus
   CHARACTER*200 FILE
 
   CHARACTER*100 line
 
   !print *, TRIM(CNFILE)
 
   OPEN(12,file=trim(CNFILE),status='old',iostat=IER)
   IF(IER .NE. 0)THEN
      WRITE(*,*),"CO2 file could not be opened"
      STOP
   ELSE
     !read(12,'()') !unit
     read(12,'()') !header

      IF(YEAR /= 1896)THEN
         DO DATE=1,YEAR-1896,1
            READ(12,*,iostat=iostatus) line
         END DO
      END IF
 
      READ(12,*,iostat=iostatus)IYEAR,VAR1,VAR2,line
      IF(IYEAR /= YEAR)THEN
       print *, YEAR,IYEAR,VAR1,VAR2,line
       print *, "Error occured"
       STOP
      END IF
      !print *,VAR1,VAR2
 
   END IF
   CLOSE(12) 
   
END SUBROUTINE RDCO2_NFERT

SUBROUTINE RDPHN(VAR1,VAR2,VAR3,PHNFILE,YEAR)

   IMPLICIT NONE
   REAL*8 VAR1,VAR2,VAR3
   REAL*8 value

   CHARACTER*200 PHNFILE

   INTEGER*4 IYEAR
   INTEGER*4 YEAR
   INTEGER DATE
   INTEGER IER,iostatus
   CHARACTER*200 FILE

   CHARACTER*100 line

   !print *, TRIM(CNFILE)

   OPEN(12,file=trim(PHNFILE),status='old',iostat=IER)
   IF(IER .NE. 0)THEN
      WRITE(*,*),"phenology file could not be opened"
      print *, PHNFILE
      STOP
   ELSE
      read(12,'()') !header
      IF(YEAR /= 1896)THEN
         DO DATE=1,YEAR-1896,1
            READ(12,*,iostat=iostatus) line
         END DO
      END IF

      READ(12,*,iostat=iostatus) IYEAR,VAR1,VAR2,VAR3
      IF(IYEAR /= YEAR)THEN
         print *, YEAR,IYEAR,VAR1,VAR2,VAR3
         print *, "Error occured"
         STOP
        END IF
      !print *,VAR1,VAR2

   END IF
   CLOSE(12)

END SUBROUTINE RDPHN

SUBROUTINE RDPLT(PLT_1st,PLT_2nd,PLT_3rd,YEAR,COUNTRY,REGION,PLT_FILE,PLT_ROW)

   IMPLICIT NONE
 
   !![OUTPUT]
   INTEGER PLT
 
   CHARACTER*200 PLT_FILE
   CHARACTER*50 COUNTRY,REGION
   INTEGER PLT_1st,PLT_2nd,PLT_3rd
   CHARACTER*50 ICOUNTRY,IREGION
 
   INTEGER YEAR
   INTEGER IER,i
   INTEGER PLT_ROW

   OPEN(15,file=trim(adjustl(PLT_FILE)),status='old',iostat=IER)
   IF(IER .NE. 0)THEN
     WRITE(*,*),"plt_file could not be opened"
     STOP
   ELSE
     READ(15,'()') !header
     DO i=1,PLT_ROW-1,1
       READ(15,'()')
     END DO

     READ(15,*) ICOUNTRY,IREGION,PLT_1st,PLT_2nd,PLT_3rd
     IF(trim(adjustl(ICOUNTRY)) /= trim(adjustl(COUNTRY)) .OR. trim(adjustl(IREGION)) /= trim(adjustl(REGION)))THEN
         print *, trim(adjustl(ICOUNTRY)), trim(adjustl(COUNTRY))
         print *, trim(adjustl(IREGION)), trim(adjustl(REGION))
         print *, PLT_1st, PLT_2nd, PLT_3rd
         STOP
     END IF
   END IF
   !print *, ICOUNTRY,IREGION,PLT_1st,PLT_2nd,PLT_3rd
   CLOSE(15)
   
END SUBROUTINE RDPLT


SUBROUTINE WRTXT_YLD(STYR,ENYR,YLDFILE,DATA,NLON,NLAT)

   IMPLICIT NONE
   
   INTEGER NLON,NLAT
   INTEGER*4 STYR
   INTEGER*4 ENYR
   REAL*8 DATA(NLON,NLAT,(ENYR-STYR+1))
   
   CHARACTER*200 YLDFILE
   
   INTEGER YEAR
   INTEGER IER,iostatus
   
   !print *, TRIM(YLDFILE)
   
   OPEN(12,file=trim(YLDFILE),status='replace',iostat=IER)
   IF(IER .NE. 0)THEN
      WRITE(*,*),"output file could not be opened"
      print *, YLDFILE
      STOP
   ELSE
      DO YEAR=1,(ENYR-STYR+1),1
         WRITE(12,*) DATA(NLON,NLAT,YEAR)
      END DO
   END IF
   CLOSE(12) 
    
END SUBROUTINE WRTXT_YLD

